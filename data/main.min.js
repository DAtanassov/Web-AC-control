var state={},settings={},setTemp,myModal,needUpdate=!1;function updateVars(){var myModal=document.getElementById("settingsModal");myModal.addEventListener("shown.bs.modal",(function(){getSettings()})),myModal.addEventListener("hide.bs.modal",(function(){needUpdate&&updateStatus()})),getSettings(),updateStatus()}function updateStatus(){$.ajax({type:"GET",url:"state",dataType:"json",beforeSend:BeforeSend,success:function(data,status,request){data&&(state=data,updateElements(),Success(data,status,request))},error:function(request,status,error){console.log("error getting state"),onError(request,status,error)},timeout:1e3})}function updateElements(){!0===state.power?($("#power").text(" ON"),$("#power-btn").addClass("btn-success"),$("#power-btn").removeClass("btn-danger")):($("#power").text(" OFF"),$("#power-btn").removeClass("btn-success"),$("#power-btn").addClass("btn-danger")),!0===state.swingvert?($("#swing-btn").removeClass("btn-outline-info"),$("#swing-btn").addClass("btn-info")):($("#swing-btn").removeClass("btn-info"),$("#swing-btn").addClass("btn-outline-info")),$("#target_temp").text(state.temp+" °C"),!0===state.econo?($("#econo-btn").removeClass("btn-outline-info"),$("#econo-btn").addClass("btn-info")):($("#econo-btn").removeClass("btn-info"),$("#econo-btn").addClass("btn-outline-info")),!0===state.lowNoise?($("#lowNoise-btn").removeClass("btn-outline-info"),$("#lowNoise-btn").addClass("btn-info")):($("#lowNoise-btn").removeClass("btn-info"),$("#lowNoise-btn").addClass("btn-outline-info")),!0===state.heatTenC?($("#heat10-btn").removeClass("btn-outline-info"),$("#heat10-btn").addClass("btn-info"),$("#target_temp").text("10 °C")):($("#heat10-btn").removeClass("btn-info"),$("#heat10-btn").addClass("btn-outline-info")),1!==settings.irModel&&4!==settings.irModel&&($("#swingH-btn").remove(),$("#stepHor-btn").remove()),!0===state.swinghor?($("#swingH-btn").removeClass("btn-outline-info"),$("#swingH-btn").addClass("btn-info")):($("#swingH-btn").removeClass("btn-info"),$("#swingH-btn").addClass("btn-outline-info")),setModeColor(state.mode),setFanColor(state.fan),document.title=state.deviceName+" v."+state.version,$("#devName").text(state.deviceName)}function BeforeSend(request){$.blockUI({css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px",opacity:.5,color:"#fff"}})}function Success(data,status,request){setTimeout($.unblockUI,0)}function onError(request,status,error){setTimeout((function(){$.unblockUI({onUnblock:function(){alert("error: "+request.responseText)}})}),2e3)}function postData(t,p){var e=new XMLHttpRequest;e.open("POST",p,!0),e.setRequestHeader("Content-Type","application/json"),console.log(JSON.stringify(t)),e.send(JSON.stringify(t))}function mode_onclick(mode){state.mode=mode,setModeColor(mode),!0===state.power&&postData(state,"state")}function setModeColor(mode){$(".mode-btn").removeClass("btn-info"),$(".mode-btn").addClass("btn-outline-info"),0===mode?($("#mode_auto").removeClass("btn-outline-info"),$("#mode_auto").addClass("btn-info")):1===mode?($("#mode_cooling").removeClass("btn-outline-info"),$("#mode_cooling").addClass("btn-info")):2===mode?($("#mode_dehum").removeClass("btn-outline-info"),$("#mode_dehum").addClass("btn-info")):3===mode?($("#mode_fan").removeClass("btn-outline-info"),$("#mode_fan").addClass("btn-info")):4===mode&&($("#mode_heating").removeClass("btn-outline-info"),$("#mode_heating").addClass("btn-info"))}function setFanColor(fan){0==fan?($("#fan_auto").removeClass("btn-outline-info"),$("#fan_auto").addClass("btn-info")):($("#fan_auto").removeClass("btn-info"),$("#fan_auto").addClass("btn-outline-info"));for(var i=1;i<=4;++i)i<=fan?$("#fan_lvl_"+i).attr("src","level_"+i+"_on.svg"):$("#fan_lvl_"+i).attr("src","level_"+i+"_off.svg")}function fan_onclick(fan){state.fan=fan,setFanColor(fan),!0===state.power&&postData(state,"state")}function power_onclick(){!0===state.power?(state.power=!1,$("#power").text(" OFF"),$("#power-btn").removeClass("btn-success"),$("#power-btn").addClass("btn-danger")):(state.power=!0,$("#power").text(" ON"),$("#power-btn").removeClass("btn-danger"),$("#power-btn").addClass("btn-success")),postData(state,"state")}function temp_onclick(temp){state.temp+=temp,1==state.mode?state.temp<18&&(state.temp=18):state.temp<16&&(state.temp=16),state.temp>30&&(state.temp=30),$("#target_temp").text(state.temp+" °C"),!0===state.power&&(clearTimeout(setTemp),setTemp=setTimeout((function(){postData(state,"state")}),1e3))}function swing_onclick(){state.swingvert?(state.swingvert=!1,$("#swing-btn").removeClass("btn-info"),$("#swing-btn").addClass("btn-outline-info")):(state.swingvert=!0,$("#swing-btn").removeClass("btn-outline-info"),$("#swing-btn").addClass("btn-info")),!0===state.power&&postData(state,"state")}function StepV_onclick(){state.swingvert=!1,$("#swing-btn").removeClass("btn-info"),$("#swing-btn").addClass("btn-outline-info"),!0===state.power&&(stepVState={stepv:!0,swingvert:!1},postData(stepVState,"stepv"))}function econo_onclick(){state.econo?(state.econo=!1,$("#econo-btn").removeClass("btn-info"),$("#econo-btn").addClass("btn-outline-info")):(state.econo=!0,$("#econo-btn").removeClass("btn-outline-info"),$("#econo-btn").addClass("btn-info")),!0===state.power&&postData(state,"econo")}function turbo_onclick(){!0===state.power&&(turboState={turbo:!0},postData(turboState,"turbo"))}function lowNoise_onclick(){state.lowNoise?(state.lowNoise=!1,$("#lowNoise-btn").removeClass("btn-info"),$("#lowNoise-btn").addClass("btn-outline-info")):(state.lowNoise=!0,$("#lowNoise-btn").removeClass("btn-outline-info"),$("#lowNoise-btn").addClass("btn-info")),!0===state.power&&postData(state,"lnoise")}function heat10_onclick(){state.heatTenC?(state.heatTenC=!1,$("#heat10-btn").removeClass("btn-info"),$("#heat10-btn").addClass("btn-outline-info"),$("#target_temp").text(state.temp+" °C")):(state.heatTenC=!0,$("#heat10-btn").removeClass("btn-outline-info"),$("#heat10-btn").addClass("btn-info"),$("#target_temp").text("10 °C")),!0===state.power&&postData(state,"heattenc")}function swingH_onclick(){state.swinghor?(state.swinghor=!1,$("#swingH-btn").removeClass("btn-info"),$("#swingH-btn").addClass("btn-outline-info")):(state.swinghor=!0,$("#swingH-btn").removeClass("btn-outline-info"),$("#swingH-btn").addClass("btn-info")),!0===state.power&&postData(state,"state")}function StepH_onclick(){state.swinghor=!1,$("#swingH-btn").removeClass("btn-info"),$("#swingH-btn").addClass("btn-outline-info"),!0===state.power&&(stepVState={steph:!0,swinghor:!1},postData(stepVState,"steph"))}function getSettings(){$.ajax({type:"GET",url:"settings",dataType:"json",success:function(data,status,request){data&&(settings=data,settingsUpdateElements())},error:function(request,status,error){console.log("error getting settings"),alert("error: "+request.responseText)},timeout:1e3}),needUpdate=!1}function settingsUpdateElements(){$.each(settings,(function(name,val){var $el=$('[name="'+name+'"]'),type;switch($el.attr("type")){case"checkbox":$el.prop("checked",val);break;case"radio":$el.filter('[value="'+val+'"]').attr("checked",val);break;default:$el.val($.isArray(val)?val:[val])}})),document.title=settings.deviceName+" (AC WiFi IR Control Settings v."+settings.version+")"}function setSettings(){settings.deviceName=$("#deviceName").val(),settings.wifiPass=$("#wifiPass").val(),settings.wifiChannel=parseInt($("#wifiChannel").val(),10),settings.startAP=!!$("#startAP").is(":checked"),settings.hideSSID=!!$("#hideSSID").is(":checked"),settings.enableIRRecv=!!$("#enableIRRecv").is(":checked"),settings.synchronise=!!$("#synchronise").is(":checked"),settings.syncMe=!!$("#syncMe").is(":checked"),settings.innerDoor=!!$("#innerDoor").is(":checked"),settings.outerDoor=!!$("#outerDoor").is(":checked"),settings.autoupdate=!!$("#autoupdate").is(":checked"),settings.updSvr=$("#updSvr").val(),settings.updSvrPort=parseInt($("#updSvrPort").val(),10),settings.useMQTT=!!$("#useMQTT").is(":checked"),settings.mqtt_broker=$("#mqtt_broker").val(),settings.mqtt_port=parseInt($("#mqtt_port").val(),10),settings.mqtt_topic=$("#mqtt_topic").val(),settings.mqtt_username=$("#mqtt_username").val(),settings.mqtt_password=$("#mqtt_password").val(),settings.irModel=parseInt($("#irModel").val(),10),postData(settings,"settings"),needUpdate=!0}function checkUPD(){postData(null,"forceupdate")}function devRestart(){postData(null,"reset")}$("#settingsModal").remove();